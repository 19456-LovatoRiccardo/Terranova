<html>
    <style>
        table,th,td {
            border : 1px solid black;
            border-collapse: collapse;
        }
        th,td {
            padding: 5px;
        }
    </style>
    
    <head>
        <title>Terranova Debug Test</title>
    </head>

    <body>
        <h2>Terranova Debug Test</h1>

        <label for="indirizzo">Indirizzo IP:</label>
        <input value="localhost" id="indirizzo">
        <label for="porta">Numero di Porta:</label>
        <input value="9091" id="porta">
        <button type="button"
                onclick="checkConnection()">
            Controlla Connessione
        </button>
        <output id="connectionResult"></output>

        <p></p>
        
        <button type="button"
                onclick="getAllAccounts()">
            Get All Accounts
        </button>
        <table id="allAccountsResult"></table>

        <p></p>

        <p>Login</p>
        <input placeholder="email" id="loginEmail">
        <input placeholder="password" id="loginPassword">
        <button type="button"
                onclick="login()">
            Login
        </button>
        <output id="loginResult"></output>

        <p></p>

        <p>Register (Non Funzionante)</p>
        <input placeholder="email" id="registerEmail">
        <input placeholder="password" id="registerPassword">
        <button type="button"
                onclick="register()">
            Register
        </button>
        <output id="registerResult"></output>

        <p></p>

        <p>Richiedi Anagrafica</p>
        <input placeholder="token" id="anagraficaToken">
        <button type="button"
                onclick="richiediAnagrafica()">
            Richiedi
        </button>
        <output id="anagraficaResult"></output>
        
        <script>
            function getIndirizzo() {
                let indirizzoIp = document.getElementById("indirizzo").value
                let numPorta = document.getElementById("porta").value
                return  "http://" + indirizzoIp + ":" + numPorta + "/api/"
            }
            function preparaRichiesta(xhttp, callback) {
                xhttp.onreadystatechange = function() {
                    if (this.readyState == 4 && this.status == 200) {
                        callback(this)
                    }
                }
                return xhttp
            }

            function checkConnection() {
                let xhttp = new XMLHttpRequest()
                preparaRichiesta(xhttp, checkConnectionResult)
                xhttp.open("GET", getIndirizzo()+"debug/checkConnection", true)
                xhttp.send()
                document.getElementById("connectionResult").innerHTML = "Connessione Fallita."
            }
            function checkConnectionResult(xhttp) {
                document.getElementById("connectionResult").innerHTML = "Connessione Riuscita!"
            }

            function getAllAccounts() {
                let xhttp = new XMLHttpRequest()
                preparaRichiesta(xhttp, allAccountsResult)
                xhttp.open("GET", getIndirizzo()+"debug/account/all", true)
                xhttp.send()
            }
            function allAccountsResult(xhttp) {
                var accounts = JSON.parse(xhttp.responseText)
                var table = ""
                table += "<tr>"
                table += "<th>Email</th>"
                table += "<th>Password</th>"
                table += "</tr>"
                for (var i=0; i < accounts.length; i++) {
                    table += "<tr>"
                    table += "<td>" + accounts[i]["email"] + "</td>"
                    table += "<td>" + accounts[i]["password"] + "</td>"
                    table += "</tr>"
                }
                document.getElementById("allAccountsResult").innerHTML = table
            }

            function register() {
                let email = document.getElementById("registerEmail").value
                let password = document.getElementById("registerPassword").value
                let body = {"email": email, "password": password}
                let xhttp = new XMLHttpRequest()
                preparaRichiesta(xhttp, registerResult)
                xhttp.open("POST", getIndirizzo()+"auth/register", true)
                xhttp.setRequestHeader("Content-Type", "application/json;charset=UTF-8")
                xhttp.send(JSON.stringify(body))
            }
            function registerResult(xhttp) {
                let token = JSON.parse(xhttp.responseText).token
                document.getElementById("registerResult").innerHTML = "Token: " + token
            }

            function login() {
                let email = document.getElementById("loginEmail").value
                let password = document.getElementById("loginPassword").value
                let body = {"email": email, "password": password}
                let xhttp = new XMLHttpRequest()
                preparaRichiesta(xhttp, loginResult)
                xhttp.open("POST", getIndirizzo()+"auth/authenticate", true)
                xhttp.setRequestHeader("Content-Type", "application/json;charset=UTF-8")
                xhttp.send(JSON.stringify(body))
            }
            function loginResult(xhttp) {
                let token = JSON.parse(xhttp.responseText).token
                document.getElementById("loginResult").innerHTML = "Token: " + token
            }

            function richiediAnagrafica() {
                let token = document.getElementById("anagraficaToken").value
                let xhttp = new XMLHttpRequest()
                preparaRichiesta(xhttp, richiediAnagraficaResult)
                xhttp.open("GET", getIndirizzo()+"privateArea/anagrafica", true)
                xhttp.setRequestHeader('Authorization','Bearer ' + token)
                xhttp.send()
            }
            function richiediAnagraficaResult(xhttp) {
                document.getElementById("anagraficaResult").innerHTML = xhttp.responseText
            }
        </script>
    </body>
</html> 
